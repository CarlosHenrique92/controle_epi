{% extends "base.html" %}
{% block title %}Itens{% endblock %}

{% block content %}
<h1>Itens de EPI</h1>
<p class="page-sub muted">Edite, exclua ou gere a etiqueta r√°pida do item.</p>

<!-- Barra de pesquisa -->
<div class="table-toolbar column-left">
  <div class="toolbar-search">
    <input class="input" id="busca-itens" placeholder="üîç Pesquisar item ou c√≥digo‚Ä¶">
  </div>
</div>

<table class="table" id="tabela-itens">
  <thead>
    <tr>
      <th>Item</th>
      <th>C√≥digo</th>
      <th>Saldo</th>
      <th class="col-acoes">A√ß√µes</th>
    </tr>
  </thead>
  <tbody>
    {% for it in itens %}
    <tr>
      <td class="col-nome">{{ it.nome }}</td>
      <td class="col-codigo small">{{ it.codigo }}</td>
      <td class="col-saldo">{{ it.saldo }}</td>
      <td class="acoes">
        <div class="actions-inline">
          <a class="btn secondary" href="{{ url_for('editar_item', item_id=it.id) }}">Editar</a>
          <a class="btn danger" href="{{ url_for('excluir_item', item_id=it.id) }}">Excluir</a>
          <a class="btn primary" target="_blank" href="{{ url_for('etiqueta', codigo=it.codigo) }}">Etiqueta r√°pida</a>
        </div>
      </td>
    </tr>
    {% endfor %}
    {% if itens|length == 0 %}
    <tr><td colspan="4">Nenhum item cadastrado.</td></tr>
    {% endif %}
  </tbody>
</table>
{% endblock %}

{% block scripts %}
<script>
  // Fun√ß√£o de normaliza√ß√£o (sem acentos e lower case)
  const normalize = (s) => (s || '')
    .toString()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .toLowerCase();

  const inputBusca = document.getElementById('busca-itens');
  const tbody = document.querySelector('#tabela-itens tbody');

  function aplicarFiltro(q){
    const query = normalize(q);
    let visiveis = 0;
    tbody.querySelectorAll('tr').forEach(tr => {
      if (tr.querySelector('.col-nome')) {
        const nome = normalize(tr.querySelector('.col-nome').textContent);
        const codigo = normalize(tr.querySelector('.col-codigo').textContent);
        const ok = !query || nome.includes(query) || codigo.includes(query);
        tr.style.display = ok ? '' : 'none';
        if (ok) visiveis++;
      }
    });

    // mensagem quando nenhum resultado for encontrado
    let noneRow = tbody.querySelector('.row-none');
    if (!noneRow) {
      noneRow = document.createElement('tr');
      noneRow.className = 'row-none';
      noneRow.innerHTML = `<td colspan="4">Nenhum item encontrado para "<b></b>".</td>`;
      noneRow.style.display = 'none';
      tbody.appendChild(noneRow);
    }
    noneRow.querySelector('b').textContent = q || '';
    noneRow.style.display = (visiveis === 0 && tbody.querySelectorAll('tr').length > 0) ? '' : 'none';
  }

  inputBusca.addEventListener('input', (e)=> aplicarFiltro(e.target.value));
</script>
{% endblock %}
