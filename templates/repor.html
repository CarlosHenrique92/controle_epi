{% extends "base.html" %}
{% block title %}Reposi√ß√£o{% endblock %}

{% block content %}
<h1>Reposi√ß√£o de Estoque</h1>
<p class="page-sub muted">Informe a quantidade a repor em cada item e clique em <b>Aplicar</b>.</p>

<!-- Barra de pesquisa -->
<div class="table-toolbar column-left">
  <div class="toolbar-search">
    <input class="input" id="busca-repor" placeholder="üîç Pesquisar item ou c√≥digo‚Ä¶">
  </div>
</div>

<form method="POST" id="form-repor">
  <table class="table" id="tabela-repor">
    <thead>
      <tr>
        <th>Item</th>
        <th>C√≥digo</th>
        <th>Saldo atual</th>
        <th>Repor</th>
      </tr>
    </thead>
    <tbody>
      {% for it in itens %}
      <tr>
        <td class="col-nome">{{ it.nome }}</td>
        <td class="col-codigo small">{{ it.codigo }}</td>
        <td>{{ it.saldo }}</td>
        <td>
          <input type="number" name="qtd_{{ it.id }}" value="0" min="0" class="input" style="max-width:100px">
        </td>
      </tr>
      {% endfor %}
      {% if itens|length == 0 %}
      <tr><td colspan="4">Nenhum item cadastrado.</td></tr>
      {% endif %}
    </tbody>
  </table>

  <div class="form-actions" style="margin-top:14px">
    <button type="submit" class="btn primary">Aplicar</button>
    <a href="{{ url_for('baixa_automatica') }}" class="btn secondary">Voltar</a>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
  // Normaliza string removendo acentos
  const normalize = (s) => (s || '')
    .toString()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .toLowerCase();

  const inputBusca = document.getElementById('busca-repor');
  const tbody = document.querySelector('#tabela-repor tbody');

  function aplicarFiltro(q){
    const query = normalize(q);
    let visiveis = 0;
    tbody.querySelectorAll('tr').forEach(tr => {
      if (tr.querySelector('.col-nome')) {
        const nome = normalize(tr.querySelector('.col-nome').textContent);
        const codigo = normalize(tr.querySelector('.col-codigo').textContent);
        const ok = !query || nome.includes(query) || codigo.includes(query);
        tr.style.display = ok ? '' : 'none';
        if (ok) visiveis++;
      }
    });

    // linha "nenhum resultado"
    let noneRow = tbody.querySelector('.row-none');
    if (!noneRow) {
      noneRow = document.createElement('tr');
      noneRow.className = 'row-none';
      noneRow.innerHTML = `<td colspan="4">Nenhum item encontrado para "<b></b>".</td>`;
      noneRow.style.display = 'none';
      tbody.appendChild(noneRow);
    }
    noneRow.querySelector('b').textContent = q || '';
    noneRow.style.display = (visiveis === 0) ? '' : 'none';
  }

  inputBusca.addEventListener('input', (e)=> aplicarFiltro(e.target.value));
</script>
{% endblock %}

